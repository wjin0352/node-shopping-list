<p align="center"><img src="examples/pu-logo.png?raw=true" alt="Pu"/></p>
Quick (and DIRTY) node.js shims for a better world!

## DO NOT USE THIS MODULE IN PRODUCTION!!! USE 'POOH' INSTEAD!!!

DEPRECATED, will merge into `pooh` soon.

## Install

<pre>
npm install pu
</pre>

Or if you also want to use the bonus CLI tool sets:

<pre>
npm install pu -g
pu --version
</pre>

Or just download `pu.js` and require the file.

**Pu** has no `dependencies`, but you can use the `devDependencies` to install some optional modules:

* Shims for popluar modules like `express` (+`serve-index`)/`cheerio`/`async`/`mongojs`/`request`;

* Minify helper needs `uglify-js`, `html-minifier`, and `clean-css`.

## Examples

**Find more in `examples/`.**

### Print method list to console

<pre>
var pu = require('pu');
pu.help();
</pre>

### Find prime numbers

Use 8 (number of cpus) cluster workers to find prime numbers, and gather the results back to master.
**See `examples/prime.js` for details.**

<pre>
// Fork workers
pu.fork(
// Workers
function(workerId,totalWorkers){
	var range = Math.floor(8000000/totalWorkers), start = (workerId-1) * range, primes = 0;
	for(var i=start;i&gt;start+range;i++){
		if(isPrime(i))
			primes++;
	}
	// Send result back to master (id=0)
	pu.tell(0,'end',primes);
},
// Master (master logic is optional)
function(totalWorkers){
	var counter = 0, primes = 0;
	// Collect all results from workers
	pu.heard('end',function(data,senderId){
		primes += data;
		if(++counter==totalWorkers)
			pu.log(primes);
	});
});
</pre>

## Shims

### Logging

#### pu.log (s, [fdOrTimestamp], [env])

Log data to console or file, with timestamp and environment modes.

<pre>
// console.log + object stringify support
pu.log("Hello World!");

// Log with timestamp
pu.log("Hello World!",true);

// Log only when global.'debugMode' is true
pu.log("Hello World!",true,'debugMode');

// Log (append) to file, automatically creates directories
pu.log("Hello World!","testfiles/log/file.log");
</pre>

#### pu.pretty (obj)

JSON.stringify with `Error` object support.

<pre>
// Return pretty printed JSON string
pu.pretty({"foo":"bar"});

// Return error info and stack as string
pu.pretty(err);
</pre>

### File System

#### pu.read (fd, [rawMode], [callback])

Read file at path `fd`.
**This method will parse `json`, `csv`, `dict`, `txt`, `log` files!**
Use `rawMode` = true to ignore file types and return the raw data.

<pre>
// Sync read
var text = pu.read("text.txt");

// Async read
pu.read("large.csv",function(data){
	pu.log(data);
});

// Ignore file types
var raw = pu.read("test.json",true);
</pre>

#### pu.byline (fd, onLine, [onEnd])

Read file at `fd` line by line using stream.

<pre>
pu.byline("words.txt", function(line) {
	// Loaded one line
}, function() {
	// Ended
});
</pre>

#### pu.write (fd, data, [callback])

Write `data` to file at `fd`, automatically creates directories.
**This method will write stringified `json`, `csv`, `dict` data to files!**

<pre>
// Sync write
pu.write("text.txt", "hello world.");

// Async write
pu.write("large.json", data, function(err){
	// ...
});
</pre>

#### pu.walk (fd)

Recursively (DFS) get all filenames under path `fd`;

<pre>
var allFiles = pu.walk("/path/images/");
</pre>

#### pu.where (fd, searchPaths)

Try to find filename `fd` under `searchPaths`.

<pre>
// Return matched path or null.
var filepath = pu.where("file.txt",["/path/to/A/","/path/to/B/","/other/path/"]);
</pre>

#### pu.ls (fd, [type], [callback])

List all files under path `fd`.
Use `callback` for async mode, or this method will be sync and returns a value.

Alias: `pu.dir`

#### pu.mv (oldPath ,newPath, [callback])

Move/rename a file or directory from `oldPath` to `newPath`.
Use `callback` for async mode, or this method will be sync.

#### pu.rm (fd, [callback])

Remove file or directory `fd`.
Use `callback` for async mode, or this method will be sync.

#### pu.mkdir (fd, [options], [callback])

Recursively create directory `fd`, with `options`.
Use `callback` for async mode, or this method will be sync.

#### pu.isdir (fd, [callback])

Check if `fd` is a directory.
Use `callback` for async mode, or this method will be sync and returns a value.

#### pu.path ([from], to)

Resolve file path

### Internet and IP

#### pu.url (from, to)

Resolve URL (to absolute URL)

#### pu.ip ()

Return internal and external IP addresses (IPv4 & IPv6).

### Cluster and Process

**Recommend to see `examples/webserver.js` for these worker communication methods.**

#### pu.fork (workerCallback, [masterCallback], [threads], [useLog])

Fork cluster workers with code inside `workerCallback`.
The `masterCallback` is optional, `pu` will setup master with default settings.
By default, `threads` = number of CPUs.

**This method also setups the worker communication methods provided by `pu`, so DO NOT use `cluster.fork()` if you need them!**

<pre>
pu.fork(function(workerId,total){
	pu.log("This is worker " + workerId + " of " + total);
},function(total){
	pu.log("I'm the master of " + total + " workers!");
});
</pre>

#### pu.heard (notificationName, callback)

Bind a `notificationName` to a `callback` function to receive data from other workers.

**This method only works within `pu.fork`!**

<pre>
pu.heard('hello',function(data,senderID){
	pu.log("Heard '" + data + "' from worker #" + senderID);
});
</pre>

**Alias: `pu.hear` / `pu.bind`**

#### pu.tell (receiverId, notificationName, data)

Send a `notificationName` with `data` to worker `receiverId` (or master: id = 0), the receiver must use `pu.heard` to bind a callback.

**This method only works within `pu.fork`!**

<pre>
// Send a JSON to worker #1
pu.tell(1,'hello', {"foo":"bar"});
</pre>

#### pu.shout (notificationName, data)

Send a `notificationName` with `data` to all workers and the master, the receivers must use `pu.heard` to bind a callback.

**This method only works within `pu.fork`!**

<pre>
// Broadcast a notification
pu.shout('hello', "Hello everybody!!!");
</pre>

#### pu.argv ([paramMap], [lowerCase], [skip])

Get the parsed `argv` map.
use `paramMap` to define flags and params length, set `lowerCase` = true for case insensitive match.

<pre>
// node test.js -port 8080 -range 0 50 100
var flags = pu.argv({"-port":1,"-range":3});
// flags["-port"] -> '8080'
// flags["-range"] -> ['0','50','100']
</pre>

#### pu.exit ()

Exit the process or end the worker.

#### pu.pid ()

Get the process ID.

#### pu.gid ([groupID])

Get or set the group ID.

#### pu.uid ([userID])

Get or set the user ID.

#### pu.tid ([titleID])

Get or set the title ID shown in the 'ps' command.

#### pu.wid ([workerID])

Get or set the worker ID in cluster.

### Math

#### pu.cos (a, b)

Return the cosine similarity of vector `a` and `b`

#### pu.intersect (a, b)

Return the intersection array / string `a` and `b`

#### pu.random (min, max)

Return a random number between `min` and `max`.

<pre>
var num = pu.random(0,1000);
</pre>

#### pu.max (array, [compareKey])

#### pu.min (array, [compareKey])

### Object Helpers

#### pu.clone (obj, [circular], [depth], [prototype])

Clone the 'obj' into a new object.

<pre>
var json = {"foo":"bar"};
var json2 = pu.clone(json);
json["foo"] = "rab";
pu.log(json);
pu.log(json2);
</pre>

#### pu.type (data)

#### pu.extend (src, ext, [noOverwirte])

Extend object `src` with `ext`.

Set `noOverwirte` = true to allow duplicated items or keep old values.

<pre>
pu.log(pu.extend([1,3,4,5],3))
pu.log(pu.extend([1,3,4,5],[2,4,3]))
</pre>

#### pu.dedup (array, [safeMode])

#### pu.remove (array, index)

#### pu.filter (array, filter)

#### pu.flat (array, key)

#### pu.isArray (object)

#### pu.isDate (object)

#### pu.isRegExp (object)

### String Operations

#### pu.clean (str)

Clean the `str`, keep only letters and digits.

#### pu.lemma (str, [exceptions])

Clean the `str`, keep only letters, digits and `[exceptions]`.

#### pu.tokenize (str, [exceptions])

Tokenize the `str` by letters, digits, and `[exceptions]`.

#### pu.replace (str, [mapOrIndexOrCommand], [text])

Replace, char exchange, and string cleaning.

<pre>
pu.log(pu.replace("abcdefg-*?",{"-":"h","*":"i","?":"j"}));

pu.log(pu.replace("abcdefg-*?","bcd","xxx"));

pu.log(pu.replace("abcdefg-*?",2,"xxx"));
</pre>

#### pu.stem (str)

**DEPRECATED**, use `clean`, `lemma` and `tokenize` instead.

#### pu.distance (source, target, [options])

Levenshtein distance of `source` and `target`.

#### pu.lcs (str1, str2)

Longest common substring of `str1` and `str2`.

#### pu.bracket (str, [pre], [suf])

Recursively unpack brackets inside string `str`.

<pre>
pu.log(pu.bracket("abc(d(e)f)g"));
</pre>

#### pu.widthconv (str)

#### pu.regstr (str, [dice])

#### pu.padnum (num, digits)

Generate fixed `digits` length string from `num`

### Time and Timer

#### pu.time ([pre], [suf])

#### pu.stopwatch (sid, [raw])

Start a new stop watch or check a existing one.

Set `raw` = true to return raw duration in ms instead of formatted string.

<pre>
pu.log(pu.stopwatch("aWatch"));
setTimeout(function(){
	pu.log(pu.stopwatch("aWatch"));
},4000);
</pre>

#### pu.interval (ms, [defMap], [noTrim])

### Parsing

#### pu.sax (str, delimiters, emitCallback)

<pre>
	emitCallback (buffer, newTag, prevTag)
</pre>

### Express Helpers

#### pu.app ([publicDir])

#### pu.server (port, handler, [sslOptions], [useLog])

#### pu.forceSecure ([defaultHost], [useLog])

#### pu.notfound (app, redirectPath)

#### pu.params (req)

#### pu.basicAuth (accounts)

#### pu.headers ([referer], [origin], [ua])

#### pu.device ([userAgent])

### CSV

#### pu.csv (strData, [delimiter])

### Crypto Helper

#### pu.hash (data, [algorithm], [saltFunc], [output])

Generate hash for `data` using `algorithm` (default = MD5).

<pre>
// MD5: 34213baa0bd3b53ee9dd8098e70da2c7
pu.log(pu.hash("peak"))

// SHA1: 6a28d069a8addd4ded3cd6e849c49cf42216d91d
pu.log(pu.hash("peak","sha1"))

// SHA1 with salt: 6b4c00dc3109d8faf9dbdaad3336110518cc6c79
pu.log(pu.hash("peak","sha1",function(data){
	return data+"ji";
}))
</pre>

### Cheerio Helper

#### pu.$ (html, [cheerio], [decodeEntities])

### Async Helper

#### pu.batch (inputs, func, [concur], [callback])

### MonogDB Helper

#### pu.mongo (server, [useLog])

### Request Helper

#### pu.download (url, [fd], [options], [callback])

### Minify Helper

#### pu.minify (file, type)

## Thanks

@[Isaac Z. Schlueter](https://github.com/isaacs "isaacs") for [rimraf](https://github.com/isaacs/rimraf "rimraf")
@[Rodrigo Guerreiro](https://github.com/rguerreiro "rguerreiro") for [express-device](https://github.com/rguerreiro/express-device "express-device")

## License

(The MIT License)

Copyright (c) 2012-2015 Yichao 'Peak' Ji

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
'Software'), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.